generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// UNIT & ROOMS
// ============================================

model Unit {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  name       String
  timezone   String   @default("America/Toronto")
  adminEmail String?

  rooms            Room[]
  chores           ChoreDefinition[]
  requests         Request[]
  concerns         Concern[]
  adminAssignments AdminUnitAssignment[]

  @@map("units")
}

model Room {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  unitId     String
  roomNumber String

  unit   Unit    @relation(fields: [unitId], references: [id], onDelete: Cascade)
  tenant Tenant?

  @@unique([unitId, roomNumber])
  @@map("rooms")
}

// ============================================
// TENANTS & OCCUPANTS
// ============================================

model Tenant {
  id            String    @id @default(uuid())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  roomId        String?   @unique
  email         String    @unique
  phone         String?
  startDate     DateTime
  endDate       DateTime?
  isActive      Boolean   @default(true)
  leaseDocument String?

  room           Room?           @relation(fields: [roomId], references: [id])
  occupants      Occupant[]
  magicLinks     MagicLink[]
  notifications  Notification[]
  requests       Request[]
  leaseDocuments LeaseDocument[]
  concernsReported Concern[]     @relation("ConcernsReported")
  concernsReceived Concern[]     @relation("ConcernsReceived")

  @@map("tenants")
}

model Occupant {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenantId  String
  name      String
  choreDay  Int? // 0=Sunday, 6=Saturday (null = not assigned)
  isActive  Boolean  @default(true)

  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  choreCompletions ChoreCompletion[]
  swapRequestsFrom SwapRequest[]     @relation("SwapRequester")
  swapRequestsTo   SwapRequest[]     @relation("SwapTarget")
  tempAssignments  TempAssignment[]

  @@map("occupants")
}

// ============================================
// AUTHENTICATION
// ============================================

enum AdminRole {
  SUPER_ADMIN
  PROPERTY_MANAGER
}

model MagicLink {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  token     String    @unique
  expiresAt DateTime
  isUsed    Boolean   @default(false)
  usedAt    DateTime?
  tenantId  String

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([token])
  @@map("magic_links")
}

model Admin {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  email     String    @unique
  name      String
  role      AdminRole @default(PROPERTY_MANAGER)

  magicLinks      AdminMagicLink[]
  unitAssignments AdminUnitAssignment[]

  @@map("admins")
}

model AdminMagicLink {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  token     String    @unique
  expiresAt DateTime
  isUsed    Boolean   @default(false)
  usedAt    DateTime?
  adminId   String

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([token])
  @@map("admin_magic_links")
}

model AdminUnitAssignment {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  adminId   String
  unitId    String

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)
  unit  Unit  @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@unique([adminId, unitId])
  @@map("admin_unit_assignments")
}

// ============================================
// CHORES
// ============================================

model ChoreDefinition {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  unitId      String
  name        String
  description String?
  icon        String?
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)

  unit        Unit              @relation(fields: [unitId], references: [id], onDelete: Cascade)
  completions ChoreCompletion[]

  @@map("chore_definitions")
}

model ChoreSchedule {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  weekId    String   @unique // "2025-W48"
  weekStart DateTime // Monday of this week

  completions  ChoreCompletion[]
  swapRequests SwapRequest[]

  @@map("chore_schedules")
}

enum CompletionStatus {
  PENDING
  COMPLETED
  MISSED
  EXCUSED
}

model ChoreCompletion {
  id              String           @id @default(uuid())
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  scheduleId      String
  occupantId      String
  choreId         String
  status          CompletionStatus @default(PENDING)
  completedAt     DateTime?
  photoPath       String?
  photoUploadedAt DateTime?
  notes           String?

  schedule ChoreSchedule   @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  occupant Occupant        @relation(fields: [occupantId], references: [id], onDelete: Cascade)
  chore    ChoreDefinition @relation(fields: [choreId], references: [id], onDelete: Cascade)

  @@unique([scheduleId, occupantId, choreId])
  @@map("chore_completions")
}

// ============================================
// SWAP REQUESTS
// ============================================

enum SwapStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  EXPIRED
}

model SwapRequest {
  id          String     @id @default(uuid())
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  requesterId String
  targetId    String
  scheduleId  String
  status      SwapStatus @default(PENDING)
  respondedAt DateTime?
  reason      String?

  requester Occupant      @relation("SwapRequester", fields: [requesterId], references: [id])
  target    Occupant      @relation("SwapTarget", fields: [targetId], references: [id])
  schedule  ChoreSchedule @relation(fields: [scheduleId], references: [id])

  @@map("swap_requests")
}

model TempAssignment {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  occupantId  String
  originalDay Int
  weekId      String
  reason      String?

  occupant Occupant @relation(fields: [occupantId], references: [id])

  @@unique([occupantId, weekId, originalDay])
  @@map("temp_assignments")
}

// ============================================
// NOTIFICATIONS
// ============================================

enum NotificationType {
  CHORE_REMINDER
  CHORE_DUE_TODAY
  CHORE_OVERDUE
  SWAP_REQUEST_RECEIVED
  SWAP_REQUEST_APPROVED
  SWAP_REQUEST_REJECTED
  WELCOME
  REQUEST_RECEIVED
  REQUEST_RESOLVED
}

model Notification {
  id          String           @id @default(uuid())
  createdAt   DateTime         @default(now())
  tenantId    String
  type        NotificationType
  title       String
  message     String
  isRead      Boolean          @default(false)
  readAt      DateTime?
  emailSent   Boolean          @default(false)
  emailSentAt DateTime?
  metadata    Json?

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, isRead])
  @@map("notifications")
}

// ============================================
// REQUESTS
// ============================================

enum RequestType {
  CLEANING_SUPPLIES
  MAINTENANCE_ISSUE
}

enum RequestStatus {
  PENDING
  RESOLVED
}

// ============================================
// CONCERNS (Tenant-to-Tenant Issues)
// ============================================

enum ConcernType {
  NOISE
  CLEANLINESS
  HARASSMENT
  PROPERTY_DAMAGE
  OTHER
}

enum ConcernSeverity {
  LOW
  MEDIUM
  HIGH
}

enum ConcernStatus {
  PENDING
  UNDER_REVIEW
  RESOLVED
  DISMISSED
}

model Request {
  id          String        @id @default(uuid())
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  tenantId    String
  unitId      String
  type        RequestType
  description String
  photoPath   String?
  status      RequestStatus @default(PENDING)
  resolvedAt  DateTime?
  resolvedBy  String?
  notes       String?

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([unitId, status])
  @@map("requests")
}

model Concern {
  id          String          @id @default(uuid())
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  reporterId  String
  reportedId  String
  unitId      String
  type        ConcernType
  severity    ConcernSeverity @default(MEDIUM)
  description String
  photoPath   String?
  status      ConcernStatus   @default(PENDING)
  resolvedAt  DateTime?
  resolvedBy  String?
  notes       String?

  reporter Tenant @relation("ConcernsReported", fields: [reporterId], references: [id], onDelete: Cascade)
  reported Tenant @relation("ConcernsReceived", fields: [reportedId], references: [id], onDelete: Cascade)
  unit     Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([reporterId])
  @@index([reportedId])
  @@index([unitId, status])
  @@map("concerns")
}

// ============================================
// LEASE DOCUMENTS
// ============================================

model LeaseDocument {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now())
  tenantId   String
  version    Int
  filename   String
  uploadedBy String
  uploadedAt DateTime @default(now())
  notes      String?
  isCurrent  Boolean  @default(true)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, version])
  @@index([tenantId, isCurrent])
  @@map("lease_documents")
}
